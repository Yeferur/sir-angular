<div class="page-container">
  <div class="page-header">
    <h1>Ver Transfers</h1>
    <div class="search-container">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A7.952 7.952 0 0 0 18 10c0-4.411-3.589-8-8-8s-8 3.589-8 8 3.589 8 8 8zm0-14c3.309 0 6 2.691 6 6s-2.691 6-6 6-6-2.691-6-6 2.691-6 6-6z"></path>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por ID, nombre, DNI, punto..."
        [value]="filters().Nombre_Titular"
        (input)="onMainSearchInput($any($event.target).value)"
        (keyup.enter)="buscarTransfers()"
        autocomplete="off"
      />
    </div>
  </div>

  <div class="filters-toolbar">
    <div class="filter-actions">
      <button class="btn-filter" (click)="advancedFiltersVisible.set(!advancedFiltersVisible())">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3H3a1 1 0 0 0-1 1v2.586a1 1 0 0 0 .293.707l6 6a1 1 0 0 1 .293.707V19a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-4.707a1 1 0 0 1 .293-.707l6-6A1 1 0 0 0 22 6.586V4a1 1 0 0 0-1-1zm-1 3.414-6 6a3 3 0 0 0-.879 2.121V19h-2v-4.464a3 3 0 0 0-.879-2.121l-6-6V5h16v1.414z"></path></svg>
        <span>Filtros</span>
      </button>

      <div class="active-filters">
        @if (filters().Fecha_Transfer) {
          <div class="filter-token">
            <span>Fecha: {{ filters().Fecha_Transfer | date:'shortDate' }}</span>
            <button class="remove-token-btn" (click)="updateFilter('Fecha_Transfer', '')">✕</button>
          </div>
        }
        @if (filters().Fecha_Registro) {
          <div class="filter-token">
            <span>Registro: {{ filters().Fecha_Registro | date:'shortDate' }}</span>
            <button class="remove-token-btn" (click)="updateFilter('Fecha_Registro', '')">✕</button>
          </div>
        }
        @if (filters().Estado?.length > 0) {
          <div class="filter-token">
            <span>Estado: {{ filters().Estado.join(', ') }}</span>
            <button class="remove-token-btn" (click)="updateFilter('Estado', [])">✕</button>
          </div>
        }
      </div>
    </div>

    <button class="btn-primary" (click)="buscarTransfers()">
      @if (!isLoadingTransfers()) { <span>Buscar</span> }
      @if (isLoadingTransfers())  { <span>Buscando...</span> }
    </button>
  </div>

  @if (advancedFiltersVisible()) {
    <div class="advanced-filters-panel">
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">Fecha del transfer</label>
          <input type="text" class="form-input" appFlatpickrInput [fpOptions]="fpOptionsFecha" [value]="filters().Fecha_Transfer" (change)="updateFilter('Fecha_Transfer', $any($event.target).value)" />
        </div>

        <div class="form-group">
          <label class="form-label">Estado</label>
          <select class="form-select" (change)="toggleSelection($any($event.target).value, 'Estado')">
            <option value="">Todos</option>
            @for (e of ['Activo', 'Pendiente', 'Completado', 'Cancelado']; track e) {
              <option [value]="e">{{ e }}</option>
            }
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Servicio</label>
          <select class="form-select" (change)="toggleSelection($any($event.target).value, 'Id_Servicio')">
            <option value="">Todos</option>
            @for (s of resultsServicios(); track s.id) {
              <option [value]="s.id">{{ s.Servicio }}</option>
            }
          </select>
        </div>
      </div>
    </div>
  }

  <div class="results-area">
    @if (!isLoadingTransfers() && transfers().length > 0) {
      <div class="results-list">
        @for (t of transfers(); track t.Id_Transfer) {
          <div class="result-item" (click)="verTransfer(t.Id_Transfer)">
            <div class="status-dot" [ngClass]="'status-' + (t.Estado ? (t.Estado | lowercase) : '')"></div>

            <div class="item-main-info">
              <span class="item-title">{{ t.Id_Transfer }} - {{ t.Nombre_Servicio || t.Nombre_Titular }}</span>
              <span class="item-subtitle">{{ t.Fecha_Transfer | date:'yyyy-MM-dd' }}</span>
            </div>

            <div class="item-secondary-info">
              <span>{{ t.Telefono_Titular || t.Telefono_Reportante }}</span>
            </div>

            <div class="item-action">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z"></path>
              </svg>
            </div>
          </div>
        }
      </div>
    }

    @if (!isLoadingTransfers() && transfers().length === 0) {
      <div class="empty-state">
        <p>No se encontraron transfers con los filtros actuales.</p>
      </div>
    }

    @if (isLoadingTransfers()) {
      <div class="loading-state">
        <p>Cargando transfers...</p>
      </div>
    }
  </div>
</div>
