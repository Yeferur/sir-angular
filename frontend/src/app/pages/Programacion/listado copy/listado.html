<div class="card">
  <div class="cardHeader">
    <h1>Programaci√≥n</h1>
  </div>
 <div class="cardBody">
    <!-- üîç FILTRO -->
    <div class="filtro-listado formRow">
      <div class="formGroup">
        <label class="formLabel">Fecha:</label>
        <input type="date" [(ngModel)]="fechaSeleccionada" class="formInput" />
      </div>
    
      <div class="formGroup">
        <label class="formLabel">Tour:</label>
        <select [(ngModel)]="tourSeleccionado" class="formInput">
          <option *ngFor="let t of tours" [value]="t.Id_Tour">{{ t.NombreTour }}</option>
        </select>
      </div>
    
      <button (click)="cargarCombinaciones()">Buscar combinaciones</button>
    </div>
    
    <!-- ‚úÖ COMBINACIONES SUGERIDAS -->
    <div *ngIf="mostrarCombinaciones && combinacionesSugeridas.length" class="combinaciones-grid">
      <h3>Selecciona una combinaci√≥n</h3>
    
      <div class="tablero">
        <div *ngFor="let combi of combinacionesSugeridas; let i = index; trackBy: trackByCombinacion"
          class="columna" (click)="seleccionarCombinacion(i)">
          <header>
            <h4>Combinaci√≥n {{ i + 1 }}</h4>
            <span>{{ combi.buses.length }} buses</span>
          </header>
          <ul>
            <li *ngFor="let bus of combi.buses">
              Capacidad: {{ bus.capacidad }} ‚Äì {{ bus.reservas.length }} reservas
            </li>
          </ul>
        </div>
      </div>
    </div>
    
    <!-- üîÑ VOLVER A VER OTRAS COMBINACIONES -->
    <button *ngIf="mostrarBotonVerOtras" (click)="verOtrasCombinaciones()">‚Üê Ver otras combinaciones</button>
    
    <!-- ‚úçÔ∏è FORMULARIO DE PLACA Y GU√çA PARA COMBINACI√ìN -->
    <div *ngIf="mostrarFormularioBuses && combinacionSeleccionada">
      <h3>Completa los datos de los buses</h3>
      <form (ngSubmit)="guardarCambios()">
        <div class="formRow">
          <div *ngFor="let bus of combinacionSeleccionada.buses; let i = index" class="bus-datos formGroup">
            <label class="formLabel">Placa del bus {{ i + 1 }}:</label>
            <input [(ngModel)]="bus.placa" name="placa-{{ i }}" class="formInput" required />
      
            <label class="formLabel">Gu√≠a:</label>
            <input [(ngModel)]="bus.guia" name="guia-{{ i }}" class="formInput" required />
          </div>
        </div>
        <button type="submit">Confirmar combinaci√≥n</button>
      </form>
    </div>
    
    <!-- üõ† OPCI√ìN MANUAL -->
    <div *ngIf="mostrarCombinaciones && combinacionesSugeridas.length" class="manual-entry">
      <button (click)="activarModoManual()">Ingresar combinaci√≥n manual</button>
    </div>
    
    <!-- üßæ FORMULARIO MANUAL -->
    <div *ngIf="modoManual">
      <h3>Crear combinaci√≥n manual</h3>
      <form (ngSubmit)="enviarCombinacionManual()">
        <div class="formRow">
          <div *ngFor="let bus of busesManual; let i = index" class="bus-datos formGroup">
            <h4>Bus {{ i + 1 }}</h4>
            <label class="formLabel">Placa:</label>
            <input [(ngModel)]="bus.placa" name="placaManual-{{ i }}" class="formInput" required />
      
            <label class="formLabel">Capacidad:</label>
            <input type="number" [(ngModel)]="bus.capacidad" name="capacidadManual-{{ i }}" class="formInput" required />
      
            <label class="formLabel">Gu√≠a:</label>
            <input [(ngModel)]="bus.guia" name="guiaManual-{{ i }}" class="formInput" required />
          </div>
        </div>
    
        <button type="button" (click)="agregarBusManual()">+ Agregar otro bus</button>
        <button type="submit">Generar listados</button>
      </form>
    </div>
    
    <!-- üîÅ BOT√ìN PARA VOLVER A EDITAR -->
    <button *ngIf="listado.buses?.length" class="btn-toggle" (click)="toggleEdit()">
      {{ editMode ? 'Salir de edici√≥n' : 'Editar listados' }}
    </button>
    <!-- =================== MODO EDICI√ìN =================== -->
    <ng-container *ngIf="editMode; else lectura">
      <div class="tablero" cdkDropListGroup>
    
        <!-- üî¥ SIN ASIGNAR -->
        <div class="columna" id="bus-sin" cdkDropList [cdkDropListData]="listado.sinAsignar"
          [cdkDropListConnectedTo]="busIds" (cdkDropListDropped)="dropReserva($event, 'sin')">
    
          <header>
            <h3>Sin asignar</h3>
            <span>{{ listado.sinAsignar.length }} reservas</span>
          </header>
    
          <ul>
            <li *ngFor="let r of listado.sinAsignar; trackBy: trackByReservaSinAsignar" cdkDrag [cdkDragData]="r">
              <div class="reserva-info">
                <div class="reserva-id"><strong>#{{ r.Id_Reserva }}</strong></div>
                <div class="reserva-punto">{{ r.NombrePunto }}</div>
                <div class="reserva-pax">{{ r.NumeroPasajeros }} pax</div>
              </div>
            </li>
          </ul>
        </div>
    
        <!-- üöå BUSES -->
        <div *ngFor="let bus of listado.buses; let i = index; trackBy: trackByBus" class="columna"
          [id]="'bus-' + i" cdkDropList [cdkDropListData]="bus.reservas"
          [cdkDropListConnectedTo]="busIds" (cdkDropListDropped)="dropReserva($event, i)">
    
          <header>
            <h3>Bus {{ i + 1 }}</h3>
            <span [class.warning]="ocupados(bus)/bus.capacidad > .9" [class.full]="ocupados(bus) >= bus.capacidad">
              {{ ocupados(bus) }}/{{ bus.capacidad }}
            </span>
            <div class="bus-meta">
              <small>Placa: {{ bus.placa || 'No asignada' }}</small><br />
              <small>Gu√≠a: {{ bus.guia || 'No asignado' }}</small>
            </div>
          </header>
    
          <ul>
            <li *ngFor="let r of bus.reservas; trackBy: trackByReserva" cdkDrag [cdkDragData]="r">
              <div class="reserva-info">
                <div class="reserva-id"><strong>#{{ r.Id_Reserva }}</strong></div>
                <div class="reserva-punto">{{ r.NombrePunto }}</div>
                <div class="reserva-pax">{{ r.NumeroPasajeros }} pax</div>
              </div>
            </li>
          </ul>
    
          <button class="btn-ver-ruta" (click)="verMapa(bus)">Ver ruta</button>
        </div>
      </div>
    
      <button class="btn-save" (click)="guardarCambios()">Guardar cambios</button>
    </ng-container>
    
    <!-- =================== MODO LECTURA =================== -->
    <ng-template #lectura>
      <div *ngIf="listado">
        <h2>Listado del {{ listado.fecha }} (Tour: {{ listado.tour }})</h2>
        <p>Total de pasajeros: {{ listado.totalPasajeros }}</p>
        <p>Combinaci√≥n usada: {{ listado.combinacionUsada.join(', ') }}</p>
    
        <div class="tablero lectura">
          <div *ngFor="let bus of listado.buses; let i = index; trackBy: trackByBus" class="columna">
            <header>
              <h3>Bus {{ i + 1 }}</h3>
              <span [class.warning]="bus.ocupados / bus.capacidad > 0.9" [class.full]="bus.ocupados >= bus.capacidad">
                {{ bus.ocupados }}/{{ bus.capacidad }}
              </span>
              <div class="bus-meta">
                <small>Placa: {{ bus.placa || 'No asignada' }}</small><br />
                <small>Gu√≠a: {{ bus.guia || 'No asignado' }}</small>
              </div>
            </header>
    
            <ul>
              <li *ngFor="let r of bus.reservas; trackBy: trackByReserva">
                <div class="reserva-info">
                  <div class="reserva-id"><strong>#{{ r.Id_Reserva }}</strong></div>
                  <div class="reserva-punto">{{ r.NombrePunto }}</div>
                  <div class="reserva-pax">{{ r.NumeroPasajeros }} pax</div>
                </div>
              </li>
            </ul>
    
            <button class="btn-ver-ruta" (click)="verMapa(bus)">Ver ruta</button>
          </div>
    
          <div *ngIf="listado.sinAsignar.length" class="columna">
            <header>
              <h3>Sin asignar</h3>
              <span>{{ listado.sinAsignar.length }} reservas</span>
            </header>
    
            <ul>
              <li *ngFor="let r of listado.sinAsignar; trackBy: trackByReservaSinAsignar">
                <div class="reserva-info">
                  <div class="reserva-id"><strong>#{{ r.Id_Reserva }}</strong></div>
                  <div class="reserva-punto">{{ r.NombrePunto }}</div>
                  <div class="reserva-pax">{{ r.NumeroPasajeros }} pax</div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </ng-template>
    
    <div *ngIf="error" class="error">{{ error }}</div>
    
 </div>
</div>