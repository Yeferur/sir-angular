<div class="page-container">
  <!-- ENCABEZADO Y BARRA DE BÚSQUEDA -->
  <div class="page-header">
    <h1>Ver Reservas</h1>
    <div class="search-container">
      <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
        <path d="M10 18a7.952 7.952 0 0 0 4.897-1.688l4.396 4.396 1.414-1.414-4.396-4.396A7.952 7.952 0 0 0 18 10c0-4.411-3.589-8-8-8s-8 3.589-8 8 3.589 8 8 8zm0-14c3.309 0 6 2.691 6 6s-2.691 6-6 6-6-2.691-6-6 2.691-6 6-6z"></path>
      </svg>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar por ID, nombre, DNI, punto..."
        [value]="filters().NombreApellido"
        (input)="onMainSearchInput($any($event.target).value)"
        (keyup.enter)="buscarReservas()"
        autocomplete="off"
        (focus)="onMainInputFocus()"
        (blur)="onMainInputBlur()"
        />
        @if (puntoAutocompleteVisible()) {
          <div class="autocomplete-dropdown">
            @for (p of puntoSugerencias(); track p) {
              <div class="autocomplete-item" (mousedown)="seleccionarPuntoAutocomplete(p)">
                <span>{{ p.NombrePunto }}</span>
              </div>
            }
          </div>
        }
      </div>
    </div>

    <!-- BARRA DE HERRAMIENTAS DE FILTROS -->
    <div class="filters-toolbar">
      <div class="filter-actions">
        <button class="btn-filter" (click)="advancedFiltersVisible.set(!advancedFiltersVisible())">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21 3H3a1 1 0 0 0-1 1v2.586a1 1 0 0 0 .293.707l6 6a1 1 0 0 1 .293.707V19a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-4.707a1 1 0 0 1 .293-.707l6-6A1 1 0 0 0 22 6.586V4a1 1 0 0 0-1-1zm-1 3.414-6 6a3 3 0 0 0-.879 2.121V19h-2v-4.464a3 3 0 0 0-.879-2.121l-6-6V5h16v1.414z"></path></svg>
          <span>Filtros</span>
        </button>

        <!-- Tokens de filtros activos -->
        <div class="active-filters">
          @if (filters().FechaReserva) {
            <div class="filter-token">
              <span>Fecha: {{ filters().FechaReserva | date:'shortDate' }}</span>
              <button class="remove-token-btn" (click)="updateFilter('FechaReserva', '')">✕</button>
            </div>
          }
          @if (filters().FechaRegistro) {
            <div class="filter-token">
              <span>Registro: {{ filters().FechaRegistro | date:'shortDate' }}</span>
              <button class="remove-token-btn" (click)="updateFilter('FechaRegistro', '')">✕</button>
            </div>
          }
          @if (filters().Estado?.length > 0) {
            <div class="filter-token">
              <span>Estado: {{ filters().Estado.join(', ') }}</span>
              <button class="remove-token-btn" (click)="updateFilter('Estado', [])">✕</button>
            </div>
          }
          @if (filters().tour?.length > 0) {
            <div class="filter-token">
              <span>Tour: {{ getSelectedToursText() }}</span>
              <button class="remove-token-btn" (click)="updateFilter('tour', [])">✕</button>
            </div>
          }
        </div>
      </div>

      <button class="btn-primary" (click)="buscarReservas()">
        @if (!isLoadingReservas()) { <span>Buscar</span> }
        @if (isLoadingReservas())  { <span>Buscando...</span> }
      </button>
    </div>

    <!-- PANEL DE FILTROS AVANZADOS (desplegable) -->
    @if (advancedFiltersVisible()) {
      <div class="advanced-filters-panel">
        <div class="form-grid">
          <!-- Fecha del Tour -->
          <div class="form-group">
            <label class="form-label">Fecha del tour</label>
            <input
              type="date"
              class="form-input"
              [value]="filters().FechaReserva"
              (change)="updateFilter('FechaReserva', $any($event.target).value)"
              />
            </div>

            <!-- Fecha de Registro -->
            <div class="form-group">
              <label class="form-label">Fecha de registro</label>
              <input
                type="date"
                class="form-input"
                [value]="filters().FechaRegistro"
                (change)="updateFilter('FechaRegistro', $any($event.target).value)"
                />
              </div>

              <!-- Estado -->
              <div class="form-group">
                <label class="form-label">Estado</label>
                <select class="form-select" (change)="toggleSelection($any($event.target).value, 'Estado')">
                  <option value="">Todos</option>
                  @for (e of ['Activo', 'Pendiente', 'Completado', 'Cancelado']; track e) {
                    <option [value]="e">{{ e }}</option>
                  }
                </select>
              </div>

              <!-- Tour -->
              <div class="form-group">
                <label class="form-label">Tour</label>
                <select class="form-select" (change)="toggleSelection($any($event.target).value, 'tour')">
                  <option value="">Todos</option>
                  @for (t of resultsTours(); track t.Id_Tour) {
                    <option [value]="t.Id_Tour">{{ t.Nombre_Tour }}</option>
                  }
                </select>
              </div>
            </div>
          </div>
        }

        <!-- ÁREA DE RESULTADOS -->
        <div class="results-area">
          @if (!isLoadingReservas() && reservas().length > 0) {
            <div class="results-list">
              @for (r of reservas(); track r.Id_Reserva) {
                <div class="result-item" (click)="verReserva(r.Id_Reserva)">
                  <div class="status-dot" [ngClass]="'status-' + (r.Estado ? (r.Estado | lowercase) : '')"></div>

                  <div class="item-main-info">
                    <span class="item-title">{{ r.Id_Reserva }} - {{ r.Nombre_Tour }}</span>
                    <span class="item-subtitle">{{ r.Fecha_Tour | date:'yyyy-MM-dd' }}</span>
                  </div>

                  <div class="item-secondary-info">
                    <span>{{ r.Pasajeros }} Pasajeros</span>
                  </div>

                  <div class="item-action">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M10.707 17.707 16.414 12l-5.707-5.707-1.414 1.414L13.586 12l-4.293 4.293z"></path>
                    </svg>
                  </div>
                </div>
              }
            </div>
          }

          @if (!isLoadingReservas() && reservas().length === 0) {
            <div class="empty-state">
              <p>No se encontraron reservas con los filtros actuales.</p>
            </div>
          }

          @if (isLoadingReservas()) {
            <div class="loading-state">
              <p>Cargando reservas...</p>
            </div>
          }
        </div>
      </div>
