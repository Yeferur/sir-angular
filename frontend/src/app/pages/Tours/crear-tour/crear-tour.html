<div class="booking-dashboard">
  <div class="page-header">
    <div>
      <h1>Crear Tour</h1>
      <p class="subtitle">
        Los campos marcados con <span class="required-star">*</span> son obligatorios.
      </p>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="submitCreateTour()">
    <div class="main-content">

      <!-- CARD 1: INFO BÁSICA -->
      <div class="card">
        <div class="card-header header-row">
          <div class="header-title">
            <h2>Información del tour</h2>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group full-width">
            <label class="form-label">Nombre del Tour <span class="required-star">*</span></label>
            <input formControlName="Nombre_Tour" type="text" class="form-input" maxlength="255"
              placeholder="Ej: Guatapé"
              [ngClass]="form.get('Nombre_Tour')?.touched && form.get('Nombre_Tour')?.invalid ? 'errorInput' : ''" />
            @if (form.get('Nombre_Tour')?.touched && form.get('Nombre_Tour')?.invalid) {
            <div class="errorMessage">Ingresa un nombre válido.</div>
            }
          </div>

          <div class="form-group">
            <label class="form-label">Abreviación <span class="required-star">*</span></label>
            <input formControlName="Abreviacion" type="text" class="form-input" maxlength="50" placeholder="Ej: TG"
              [ngClass]="form.get('Abreviacion')?.touched && form.get('Abreviacion')?.invalid ? 'errorInput' : ''" />
            @if (form.get('Abreviacion')?.touched && form.get('Abreviacion')?.invalid) {
            <div class="errorMessage">La abreviación es obligatoria.</div>
            }
          </div>

          <div class="form-group">
            <label class="form-label">Cupo Base <span class="required-star">*</span></label>
            <input formControlName="Cupo_Base" type="number" class="form-input" min="0" placeholder="0"
              [ngClass]="form.get('Cupo_Base')?.touched && form.get('Cupo_Base')?.invalid ? 'errorInput' : ''" />
            @if (form.get('Cupo_Base')?.touched && form.get('Cupo_Base')?.invalid) {
            <div class="errorMessage">El cupo base es obligatorio.</div>
            }
          </div>

          <div class="form-group full-width">
            <label class="form-label">Copiar Horarios de Tour Existente (Opcional)</label>
            <select formControlName="Id_Tour_Origen" class="form-input">
              <option [ngValue]="null">Pendiente</option>
              @for (tour of toursExistentes; track tour.Id_Tour) {
              <option [ngValue]="tour.Id_Tour">{{ tour.Nombre_Tour }}</option>
              }
            </select>
            <small class="form-hint">
              Si seleccionas un tour, se copiarán sus horarios. Si no, todos los horarios quedarán en “Pendiente”.
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Comisión Hotel</label>
            <input formControlName="Comision_Hotel" type="number" class="form-input" min="0" placeholder="0" />
          </div>

          <div class="form-group">
            <label class="form-label">Comisión Agencia</label>
            <input formControlName="Comision_Agencia" type="number" class="form-input" min="0" placeholder="0" />
          </div>

          <div class="form-group">
            <label class="form-label">Comisión Freelance</label>
            <input formControlName="Comision_Freelance" type="number" class="form-input" min="0" placeholder="0" />
          </div>

          <div class="form-group">
            <label class="form-label">Latitud <span class="required-star">*</span></label>
            <input formControlName="Latitud" type="number" class="form-input" step="any" placeholder="6.24..."
              [ngClass]="form.get('Latitud')?.touched && form.get('Latitud')?.invalid ? 'errorInput' : ''" />
          </div>

          <div class="form-group">
            <label class="form-label">Longitud <span class="required-star">*</span></label>
            <input formControlName="Longitud" type="number" class="form-input" step="any" placeholder="-75.57..."
              [ngClass]="form.get('Longitud')?.touched && form.get('Longitud')?.invalid ? 'errorInput' : ''" />
          </div>
        </div>
      </div>

      <!-- CARD 2: PLANES + PRECIOS -->
      <div class="card">
        <div class="card-header header-row">
          <div class="header-title">
            <h2>Planes y precios</h2>
          </div>
          <div class="header-actions">
            <button type="button" class="btn-secondary" (click)="addNewPlan()">+ Agregar plan</button>
          </div>
        </div>

        <div formArrayName="planes" class="planes-list">
          @for (planCtrl of plans.controls; track $index; let i = $index) {
          <div class="card plan-card" [formGroupName]="i">

            <div class="plan-row">
                @if (i !== 0) {
            <div class="btn-header">
                <button type="button" class="btn-icon-delete" (click)="deletePlan(i)">✕</button>
            </div>
              }
              <div class="plan-main">
                <label class="form-label">Nombre del plan <span class="required-star">*</span></label>
                <input type="text" formControlName="Nombre_Plan" class="form-input"
                  placeholder="Ej: Plan básico / Premium"
                  [ngClass]="planCtrl.get('Nombre_Plan')?.touched && planCtrl.get('Nombre_Plan')?.invalid ? 'errorInput' : ''" />
                @if (planCtrl.get('Nombre_Plan')?.touched && planCtrl.get('Nombre_Plan')?.invalid) {
                <div class="errorMessage">El nombre del plan es obligatorio.</div>
                }
                @if (i === 0) { <small class="form-hint">Este plan es el principal del tour.</small> }
              </div>

            
            </div>

            <div class="plan-controls">
              <button type="button" class="perm-btn" [class.active]="planCtrl.get('AllowNino')?.value"
                (click)="planCtrl.get('AllowNino')?.setValue(!planCtrl.get('AllowNino')?.value); togglePassengerType(i, 'NINO')">
                <span class="perm-codigo">Permite Niños</span>
              </button>

              <button type="button" class="perm-btn" [class.active]="planCtrl.get('AllowInfante')?.value"
                (click)="planCtrl.get('AllowInfante')?.setValue(!planCtrl.get('AllowInfante')?.value); togglePassengerType(i, 'INFANTE')">
                <span class="perm-codigo">Permite Infantes</span>
              </button>
            </div>

            <div formArrayName="monedas" class="plan-monedas">
              @for (monCtrl of getPlanCurrencies(i).controls; track $index; let mi = $index) {
              <div class="card moneda-card" [formGroupName]="mi">

                <div class="moneda-row">
                  <div>
                      <div class="form-label">
                        {{ monCtrl.get('Nombre_Moneda')?.value }} ({{ monCtrl.get('Codigo')?.value }})
                      </div>
                    @if (isBaseCop(i, mi)) {
                    }
                  </div>
                </div>

                <div class="moneda-grid">

                  <!-- ADULTO -->
                  <div>
                    <label class="form-label">
                      Adulto @if (isAdultRequired(i, mi)) { <span class="required-star">*</span> }
                    </label>
                    <input type="number" class="form-input" formControlName="ADULTO" min="0" placeholder="0"
                      [ngClass]="monCtrl.get('ADULTO')?.touched && monCtrl.get('ADULTO')?.invalid ? 'errorInput' : ''" />
                    @if (monCtrl.get('ADULTO')?.touched && monCtrl.get('ADULTO')?.invalid) {
                    <div class="errorMessage">
                      {{ getAdultErrorMessage(i, mi) }}
                    </div>
                    }
                  </div>

                  <!-- NIÑO -->
                  <div>
                    <label class="form-label">Niño</label>
                    <input type="number" class="form-input" formControlName="NINO" min="0" placeholder="0"
                      [ngClass]="monCtrl.get('NINO')?.touched && monCtrl.get('NINO')?.invalid ? 'errorInput' : ''" />
                    @if (planCtrl.get('AllowNino')?.value && monCtrl.get('NINO')?.touched &&
                    monCtrl.get('NINO')?.invalid) {
                    <div class="errorMessage">{{ getChildErrorMessage(i, mi) }}</div>
                    }
                  </div>

                  <!-- INFANTE -->
                  <div>
                    <label class="form-label">Infante</label>
                    <input type="number" class="form-input" formControlName="INFANTE" min="0" placeholder="0"
                      [ngClass]="monCtrl.get('INFANTE')?.touched && monCtrl.get('INFANTE')?.invalid ? 'errorInput' : ''" />
                    @if (planCtrl.get('AllowInfante')?.value && monCtrl.get('INFANTE')?.touched &&
                    monCtrl.get('INFANTE')?.invalid) {
                    <div class="errorMessage">{{ getInfantErrorMessage(i, mi) }}</div>
                    }
                  </div>

                </div>
              </div>
              }
            </div>

          </div>
          }
        </div>
      </div>
      <!-- CARD 3: DISPONIBILIDAD Y TEMPORADAS -->
      <div class="card card--spaced">
        <div class="card-header header-row">
          <div class="header-title">
            <h2>Disponibilidad y temporadas</h2>
          </div>
        </div>

        <!-- MODO -->
        <div class="form-grid">
          <div class="form-group full-width">
            <label class="form-label">Modo de disponibilidad</label>

            <div class="segmented-wrapper">
              <div class="segmented-control">
                <button type="button" [class.active]="form.get('Modo_Disponibilidad')?.value === 'TODO_EL_ANO'"
                  (click)="form.get('Modo_Disponibilidad')?.setValue('TODO_EL_ANO')">
                  Disponible todo el año
                </button>

                <button type="button" [class.active]="form.get('Modo_Disponibilidad')?.value === 'SOLO_TEMPORADAS'"
                  (click)="form.get('Modo_Disponibilidad')?.setValue('SOLO_TEMPORADAS')">
                  Disponible solo por temporadas
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- DÍAS BASE -->
        @if (!isSoloTemporadas()) {
        <div class="section-divider">
            <div class="section-header-row">
            <div>
              <div class="form-label">Días de operación</div>
            </div>

            <div class="button-row header-actions">
              <button type="button" class="btn-secondary btn-toggle" (click)="toggleAllBaseDaysToggle()">{{ areAllBaseDaysSelected() ? 'Ninguno' : 'Todos' }}</button>
            </div>
          </div>

          <div [formGroup]="diasBaseFG" class="days-row">
            @for (d of diasSemana; track d.key) {
            <label class="day-chip">
              <input type="checkbox" [formControlName]="d.key" />
              <span>{{ d.label }}</span>
            </label>
            }
          </div>
        </div>
        }

        <!-- TEMPORADAS -->
        <div class="section-divider">
            <div class="section-header-row">
            <div>
              <div class="strong-title">Temporadas</div>
            </div>

            <div class="header-actions">
              <button type="button" class="btn-secondary" (click)="addTemporada()">+ Agregar temporada</button>
            </div>
          </div>

          @if (temporadasFA.touched && temporadasFA.invalid && temporadasFA.errors?.['requereTemporada']) {
          <div class="errorMessage mt-10">
            Debes agregar al menos una temporada en el modo “Solo por temporadas”.
          </div>
          }

          <div formArrayName="temporadas" class="temporadas-list">
            @for (tempCtrl of temporadasFA.controls; track $index; let ti = $index) {
            <div class="card temporada-card" [formGroupName]="ti">

              <div class="plan-row">
                <div class="btn-header">
                  <button type="button" class="btn-icon-delete" (click)="deleteTemporada(ti)">✕</button>
                </div>
                <div class="plan-main">
                  <label class="form-label">Nombre de temporada <span class="required-star">*</span></label>
                  <input type="text" class="form-input" [ngClass]="tempCtrl.get('Nombre_Temporada')?.touched && tempCtrl.get('Nombre_Temporada')?.invalid ? 'errorInput' : ''" formControlName="Nombre_Temporada"
                    placeholder="Ej: Diciembre (alta)" />
                  @if (tempCtrl.get('Nombre_Temporada')?.touched && tempCtrl.get('Nombre_Temporada')?.invalid) {
                  <div class="errorMessage">Nombre obligatorio.</div>
                  }
                </div>

                
              </div>

              <div class="temp-grid">
                <div>
                  <label class="form-label">Fecha inicio <span class="required-star">*</span></label>
                  <input type="text" class="form-input" appFlatpickrInput [fpOptions]="fpOptionsFecha" [ngClass]="tempCtrl.get('Fecha_Inicio')?.touched && tempCtrl.get('Fecha_Inicio')?.invalid ? 'errorInput' : ''" formControlName="Fecha_Inicio" />
                  @if (tempCtrl.get('Fecha_Inicio')?.touched && tempCtrl.get('Fecha_Inicio')?.invalid) {
                  <div class="errorMessage">Obligatoria.</div>
                  }
                </div>

                <div>
                  <label class="form-label">Fecha fin <span class="required-star">*</span></label>
                  <input type="text" class="form-input" appFlatpickrInput [fpOptions]="fpOptionsFecha" [ngClass]="tempCtrl.get('Fecha_Fin')?.touched && tempCtrl.get('Fecha_Fin')?.invalid ? 'errorInput' : ''" formControlName="Fecha_Fin" />
                  @if (tempCtrl.get('Fecha_Fin')?.touched && tempCtrl.get('Fecha_Fin')?.invalid) {
                  <div class="errorMessage">Obligatoria.</div>
                  }
                </div>
              </div>

              @if (tempCtrl.touched && tempCtrl.errors?.['rangoInvalido']) {
              <div class="errorMessage mt-10">
                La fecha fin no puede ser menor que la fecha inicio.
              </div>
              }

              <div class="mt-14">
                <div class="section-header-row">
                  <div class="form-label">Días de operación de la temporada <span class="required-star">*</span></div>
                  <div class="button-row header-actions">
                    <button type="button" class="btn-secondary btn-toggle" (click)="toggleAllSeasonDaysToggle(ti)">{{ areAllSeasonDaysSelected(ti) ? 'Ninguno' : 'Todos' }}</button>
                  </div>
                </div>

                <div formGroupName="dias" class="days-row">
                  @for (d of diasSemana; track d.key) {
                  <label class="day-chip">
                    <input type="checkbox" [formControlName]="d.key" />
                    <span>{{ d.label }}</span>
                  </label>
                  }
                </div>

                @if (tempCtrl.touched && tempCtrl.errors?.['sinDias']) {
                <div class="errorMessage mt-10">
                  Selecciona al menos un día para esta temporada.
                </div>
                }
              </div>

            </div>
            }
          </div>
        </div>
      </div>

      <div class="actions-end">
        <button class="btn-primary" type="submit" [disabled]="isLoading">
          {{ isLoading ? 'Guardando...' : 'Crear Tour' }}
        </button>
      </div>

    </div>
  </form>
</div>